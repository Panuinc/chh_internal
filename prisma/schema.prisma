generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum employeeStatus {
  Active
  Inactive
}

enum accountStatus {
  Active
  Inactive
}

enum permissionStatus {
  Active
  Inactive
}

enum departmentStatus {
  Active
  Inactive
}

enum VisitorStatus {
  CheckIn
  CheckOut
}

enum SalesMemoStatus {
  DRAFT
  PENDING_SALES_MANAGER
  PENDING_CEO
  APPROVED
  REJECTED
}

enum visitorContactReason {
  Shipping
  BillingChequeCollection
  JobApplication
  ProductPresentation
  Meeting
  Other
}

model Employee {
  employeeId           String         @id @default(cuid())
  employeeFirstName    String
  employeeLastName     String
  employeeEmail        String         @unique
  employeeStatus       employeeStatus @default(Active)
  employeeDepartmentId String?
  employeeCreatedBy    String?
  employeeCreatedAt    DateTime?
  employeeUpdatedBy    String?
  employeeUpdatedAt    DateTime?

  department Department? @relation(fields: [employeeDepartmentId], references: [departmentId])

  createdByEmployee Employee? @relation("EmployeeCreatedBy", fields: [employeeCreatedBy], references: [employeeId])
  updatedByEmployee Employee? @relation("EmployeeUpdatedBy", fields: [employeeUpdatedBy], references: [employeeId])

  createdEmployees Employee[] @relation("EmployeeCreatedBy")
  updatedEmployees Employee[] @relation("EmployeeUpdatedBy")

  account Account?

  // RBAC: Employee can have multiple Roles
  employeeRoles EmployeeRole[]

  createdAccounts Account[] @relation("AccountCreatedBy")
  updatedAccounts Account[] @relation("AccountUpdatedBy")

  createdPermissions Permission[] @relation("PermissionCreatedBy")
  updatedPermissions Permission[] @relation("PermissionUpdatedBy")

  createdDepartments Department[] @relation("DepartmentCreatedBy")
  updatedDepartments Department[] @relation("DepartmentUpdatedBy")

  createdRoles Role[] @relation("RoleCreatedBy")
  updatedRoles Role[] @relation("RoleUpdatedBy")

  // RBAC Relations
  createdEmployeeRoles EmployeeRole[] @relation("EmployeeRoleCreatedBy")
  updatedEmployeeRoles EmployeeRole[] @relation("EmployeeRoleUpdatedBy")
  createdRolePermissions RolePermission[] @relation("RolePermissionCreatedBy")
  updatedRolePermissions RolePermission[] @relation("RolePermissionUpdatedBy")

  contactVisitors Visitor[] @relation("VisitorContactUserRelation")

  createdVisitors Visitor[] @relation("VisitorCreatedBy")
  updatedVisitors Visitor[] @relation("VisitorUpdatedBy")

  createdPatrols Patrol[] @relation("PatrolCreatedBy")
  updatedPatrols Patrol[] @relation("PatrolUpdatedBy")

  createdSalesMemos SalesMemo[] @relation("SalesMemoCreatedBy")
  updatedSalesMemos SalesMemo[] @relation("SalesMemoUpdatedBy")
  salesManagerMemos SalesMemo[] @relation("SalesMemoSalesManager")
  ceoMemos          SalesMemo[] @relation("SalesMemoCeo")
  rejectedMemos     SalesMemo[] @relation("SalesMemoRejectedBy")

  createdEMSTrackings EMSTracking[] @relation("EMSTrackingCreatedBy")
  updatedEMSTrackings EMSTracking[] @relation("EMSTrackingUpdatedBy")

  @@index([employeeDepartmentId])
  @@index([employeeCreatedBy])
  @@index([employeeUpdatedBy])
}

model Account {
  accountId         String        @id @default(cuid())
  accountEmployeeId String        @unique
  accountUsername   String
  accountPassword   String
  accountPinNumber  String?
  accountStatus     accountStatus @default(Inactive)
  accountCreatedBy  String?
  accountCreatedAt  DateTime?
  accountUpdatedBy  String?
  accountUpdatedAt  DateTime?

  accountEmployee Employee @relation(fields: [accountEmployeeId], references: [employeeId])

  createdByEmployee Employee? @relation("AccountCreatedBy", fields: [accountCreatedBy], references: [employeeId])
  updatedByEmployee Employee? @relation("AccountUpdatedBy", fields: [accountUpdatedBy], references: [employeeId])

  refreshTokens RefreshToken[]

  @@index([accountCreatedBy])
  @@index([accountUpdatedBy])
}

model Permission {
  permissionId        String           @id @default(cuid())
  permissionName      String           @unique
  permissionStatus    permissionStatus @default(Active)
  permissionCreatedBy String?
  permissionCreatedAt DateTime?
  permissionUpdatedBy String?
  permissionUpdatedAt DateTime?

  // RBAC: Permission belongs to many Roles
  rolePermissions RolePermission[]

  createdByEmployee Employee? @relation("PermissionCreatedBy", fields: [permissionCreatedBy], references: [employeeId])
  updatedByEmployee Employee? @relation("PermissionUpdatedBy", fields: [permissionUpdatedBy], references: [employeeId])

  @@index([permissionCreatedBy])
  @@index([permissionUpdatedBy])
}

model Role {
  roleId        String           @id @default(cuid())
  roleName      String           @unique
  roleStatus    departmentStatus @default(Active)
  roleCreatedBy String?
  roleCreatedAt DateTime?
  roleUpdatedBy String?
  roleUpdatedAt DateTime?

  // RBAC: Role has many Permissions
  rolePermissions RolePermission[]
  
  // RBAC: Role assigned to many Employees
  employeeRoles EmployeeRole[]

  createdByEmployee Employee? @relation("RoleCreatedBy", fields: [roleCreatedBy], references: [employeeId])
  updatedByEmployee Employee? @relation("RoleUpdatedBy", fields: [roleUpdatedBy], references: [employeeId])

  @@index([roleCreatedBy])
  @@index([roleUpdatedBy])
}

// RBAC: Junction table for Role-Permission Many-to-Many
model RolePermission {
  rolePermissionId           String    @id @default(cuid())
  rolePermissionRoleId       String
  rolePermissionPermissionId String
  rolePermissionCreatedBy    String?
  rolePermissionCreatedAt    DateTime?
  rolePermissionUpdatedBy    String?
  rolePermissionUpdatedAt    DateTime?

  role       Role       @relation(fields: [rolePermissionRoleId], references: [roleId], onDelete: Cascade)
  permission Permission @relation(fields: [rolePermissionPermissionId], references: [permissionId], onDelete: Cascade)
  createdBy  Employee?  @relation("RolePermissionCreatedBy", fields: [rolePermissionCreatedBy], references: [employeeId])
  updatedBy  Employee?  @relation("RolePermissionUpdatedBy", fields: [rolePermissionUpdatedBy], references: [employeeId])

  @@unique([rolePermissionRoleId, rolePermissionPermissionId])
  @@index([rolePermissionRoleId])
  @@index([rolePermissionPermissionId])
  @@index([rolePermissionCreatedBy])
  @@index([rolePermissionUpdatedBy])
}

// RBAC: Junction table for Employee-Role Many-to-Many
model EmployeeRole {
  employeeRoleId        String    @id @default(cuid())
  employeeRoleEmployeeId String
  employeeRoleRoleId    String
  employeeRoleCreatedBy String?
  employeeRoleCreatedAt DateTime?
  employeeRoleUpdatedBy String?
  employeeRoleUpdatedAt DateTime?

  employee  Employee  @relation(fields: [employeeRoleEmployeeId], references: [employeeId], onDelete: Cascade)
  role      Role      @relation(fields: [employeeRoleRoleId], references: [roleId], onDelete: Cascade)
  createdBy Employee? @relation("EmployeeRoleCreatedBy", fields: [employeeRoleCreatedBy], references: [employeeId])
  updatedBy Employee? @relation("EmployeeRoleUpdatedBy", fields: [employeeRoleUpdatedBy], references: [employeeId])

  @@unique([employeeRoleEmployeeId, employeeRoleRoleId])
  @@index([employeeRoleEmployeeId])
  @@index([employeeRoleRoleId])
  @@index([employeeRoleCreatedBy])
  @@index([employeeRoleUpdatedBy])
}

model Department {
  departmentId        String           @id @default(cuid())
  departmentName      String           @unique
  departmentStatus    departmentStatus @default(Active)
  departmentCreatedBy String?
  departmentCreatedAt DateTime?
  departmentUpdatedBy String?
  departmentUpdatedAt DateTime?

  employees Employee[]

  createdByEmployee Employee? @relation("DepartmentCreatedBy", fields: [departmentCreatedBy], references: [employeeId])
  updatedByEmployee Employee? @relation("DepartmentUpdatedBy", fields: [departmentUpdatedBy], references: [employeeId])

  @@index([departmentCreatedBy])
  @@index([departmentUpdatedBy])
}

model Visitor {
  visitorId              String               @id @default(cuid())
  visitorFirstName       String
  visitorLastName        String
  visitorCompany         String
  visitorCarRegistration String
  visitorProvince        String
  visitorContactUserId   String
  visitorContactReason   visitorContactReason
  visitorPhoto           String
  visitorDocumentPhotos  String
  visitorStatus          VisitorStatus        @default(CheckIn)
  visitorCreatedBy       String
  visitorCreatedAt       DateTime
  visitorUpdatedBy       String?
  visitorUpdatedAt       DateTime?

  contactUser       Employee? @relation("VisitorContactUserRelation", fields: [visitorContactUserId], references: [employeeId])
  createdByEmployee Employee? @relation("VisitorCreatedBy", fields: [visitorCreatedBy], references: [employeeId])
  updatedByEmployee Employee? @relation("VisitorUpdatedBy", fields: [visitorUpdatedBy], references: [employeeId])

  @@index([visitorContactUserId])
  @@index([visitorCreatedBy])
  @@index([visitorUpdatedBy])
}

model Patrol {
  patrolId         String    @id @default(cuid())
  patrolQrCodeInfo String
  patrolPicture    String
  patrolNote       String
  patrolCreatedBy  String?
  patrolCreatedAt  DateTime?
  patrolUpdatedBy  String?
  patrolUpdatedAt  DateTime?

  createdByEmployee Employee? @relation("PatrolCreatedBy", fields: [patrolCreatedBy], references: [employeeId])
  updatedByEmployee Employee? @relation("PatrolUpdatedBy", fields: [patrolUpdatedBy], references: [employeeId])

  @@index([patrolCreatedBy])
  @@index([patrolUpdatedBy])
}

model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique
  accountId String
  account   Account   @relation(fields: [accountId], references: [accountId], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?
  ipAddress String?
  userAgent String?

  @@index([accountId])
  @@index([token])
  @@index([expiresAt])
}

model SalesMemo {
  memoId            String          @id @default(cuid())
  memoDocumentNo    String          @unique
  memoTo            String
  memoCopy          String?
  memoSubject       String
  memoDate          DateTime
  memoContent       String          @db.Text
  memoRequesterName String
  memoRequesterDate DateTime?
  memoStatus        SalesMemoStatus @default(DRAFT)

  // Sales Manager Approval
  memoSalesManagerId   String?
  memoSalesManagerName String?
  memoSalesManagerDate DateTime?

  // CEO Approval
  memoCeoId   String?
  memoCeoName String?
  memoCeoDate DateTime?

  // Rejection
  memoRejectedById   String?
  memoRejectedByName String?
  memoRejectedAt     DateTime?
  memoRejectReason   String?

  memoCreatedBy String?
  memoCreatedAt DateTime  @default(now())
  memoUpdatedBy String?
  memoUpdatedAt DateTime?

  createdByEmployee    Employee? @relation("SalesMemoCreatedBy", fields: [memoCreatedBy], references: [employeeId])
  updatedByEmployee    Employee? @relation("SalesMemoUpdatedBy", fields: [memoUpdatedBy], references: [employeeId])
  salesManagerEmployee Employee? @relation("SalesMemoSalesManager", fields: [memoSalesManagerId], references: [employeeId])
  ceoEmployee          Employee? @relation("SalesMemoCeo", fields: [memoCeoId], references: [employeeId])
  rejectedByEmployee   Employee? @relation("SalesMemoRejectedBy", fields: [memoRejectedById], references: [employeeId])

  @@index([memoDocumentNo])
  @@index([memoStatus])
  @@index([memoCreatedBy])
  @@index([memoUpdatedBy])
  @@index([memoCreatedAt])
  @@index([memoSalesManagerId])
  @@index([memoCeoId])
}

enum EMSTrackingStatus {
  NOT_CALLED
  CALLED_NOT_RECEIVED
  CALLED_RECEIVED
  CANNOT_CONTACT
}

model EMSTracking {
  emsId           String            @id @default(cuid())
  emsBarcode      String            @unique
  emsCustomerName String?
  emsStatus       EMSTrackingStatus @default(NOT_CALLED)
  emsNotes        String?           @db.Text
  emsCallDate     DateTime?
  emsLastTracking Json?             // เก็บข้อมูล tracking ล่าสุดจากไปรษณีย์
  emsCreatedBy    String?
  emsCreatedAt    DateTime          @default(now())
  emsUpdatedBy    String?
  emsUpdatedAt    DateTime?

  createdByEmployee Employee? @relation("EMSTrackingCreatedBy", fields: [emsCreatedBy], references: [employeeId])
  updatedByEmployee Employee? @relation("EMSTrackingUpdatedBy", fields: [emsUpdatedBy], references: [employeeId])

  @@index([emsBarcode])
  @@index([emsStatus])
  @@index([emsCreatedBy])
  @@index([emsUpdatedBy])
  @@index([emsCreatedAt])
}
